<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TA Monitor ‚Äî Analytics</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script>
// Load Chart.js with fallbacks
(function(){
  const urls=[
    'https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.7/chart.umd.min.js',
    'https://unpkg.com/chart.js@4.4.7/dist/chart.umd.min.js'
  ];
  let i=0;
  function tryLoad(){
    if(i>=urls.length){document.getElementById('kpiSection').innerHTML='<div style="color:#e74c3c;text-align:center;padding:40px">Impossibile caricare Chart.js. Prova a disabilitare ad-blocker o estensioni.</div>';return}
    const s=document.createElement('script');s.src=urls[i];
    s.onload=function(){console.log('Chart.js loaded from:',urls[i])};
    s.onerror=function(){console.warn('Failed:',urls[i]);i++;tryLoad()};
    document.head.appendChild(s)
  }
  tryLoad()
})();
</script>
<style>
:root{--bg:#0a0a0f;--surface:#13131a;--surface2:#1a1a24;--border:#2a2a3a;--border-focus:#6c5ce7;--text:#e8e8f0;--text-dim:#8888a0;--accent:#6c5ce7;--accent-hover:#7d6ff0;--accent-glow:rgba(108,92,231,.15);--danger:#e74c3c;--success:#27ae60;--success-glow:rgba(39,174,96,.15);--warn:#f39c12;--radius:10px;--radius-sm:6px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}
.noise{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.03;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}
.container{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:32px 24px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;padding-bottom:16px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:12px}
.header h1{font-size:1.4rem;font-weight:700}.header h1 span{color:var(--accent)}
.header-actions{display:flex;gap:8px;align-items:center}
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:.83rem;font-weight:500;cursor:pointer;transition:all .2s;text-decoration:none}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:var(--accent-hover)}
.btn-ghost{background:transparent;color:var(--text-dim);border:1px solid var(--border)}.btn-ghost:hover{color:var(--text)}
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;width:100%;max-width:400px;text-align:center}
.login-box h1{font-size:1.4rem;margin-bottom:6px}.login-box h1 span{color:var(--accent)}
.login-box p{color:var(--text-dim);font-size:.85rem;margin-bottom:28px}
.field{margin-bottom:16px;text-align:left}.field label{display:block;font-size:.8rem;color:var(--text-dim);margin-bottom:4px}
.field input,.field select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;color:var(--text);font-family:inherit;font-size:.9rem}
.field input:focus,.field select:focus{outline:none;border-color:var(--border-focus)}
.error{color:var(--danger);font-size:.82rem;margin-bottom:12px;min-height:20px}

/* Profile selector */
.profile-selector{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
.profile-selector label{font-size:.85rem;color:var(--text-dim)}
.profile-selector select{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 14px;color:var(--text);font-family:inherit;font-size:.85rem;min-width:220px}
.profile-selector select:focus{outline:none;border-color:var(--accent)}

/* KPI cards */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:28px}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;text-align:center}
.kpi .num{font-size:2rem;font-weight:700;color:var(--accent);line-height:1.1}
.kpi .label{font-size:.78rem;color:var(--text-dim);margin-top:4px}
.kpi .delta{font-size:.75rem;margin-top:4px}
.kpi .delta.up{color:var(--success)}.kpi .delta.down{color:var(--danger)}.kpi .delta.flat{color:var(--text-dim)}

/* Chart panels */
.chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px}
.chart-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;min-height:320px}
.chart-panel.full{grid-column:1/-1}
.chart-panel h3{font-size:.92rem;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.chart-wrap{position:relative;height:260px}

/* Insights */
.insights{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:28px}
.insights h3{font-size:.92rem;font-weight:600;margin-bottom:14px}
.insight-item{padding:10px 14px;border-left:3px solid var(--accent);background:var(--surface2);border-radius:0 var(--radius-sm) var(--radius-sm) 0;margin-bottom:8px;font-size:.85rem}
.insight-item.warn{border-left-color:var(--warn)}
.insight-item.good{border-left-color:var(--success)}
.insight-item .tag{font-size:.72rem;padding:2px 6px;border-radius:8px;margin-right:6px;font-weight:500}
.insight-item .tag.trend{background:rgba(108,92,231,.15);color:var(--accent)}
.insight-item .tag.alert{background:rgba(243,156,18,.15);color:var(--warn)}
.insight-item .tag.opportunity{background:rgba(39,174,96,.15);color:var(--success)}

/* Table */
.rank-table{width:100%;border-collapse:collapse;font-size:.83rem}
.rank-table th{text-align:left;padding:8px 10px;font-size:.72rem;color:var(--text-dim);text-transform:uppercase;border-bottom:1px solid var(--border)}
.rank-table td{padding:8px 10px;border-bottom:1px solid var(--border)}
.rank-table tr:hover td{background:var(--surface2)}
.rank-table .bar{height:6px;border-radius:3px;background:var(--accent);display:inline-block;vertical-align:middle;margin-left:8px}

.loading{display:flex;align-items:center;justify-content:center;min-height:200px;color:var(--text-dim);font-size:.9rem}
.spinner{width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:24px;right:24px;padding:10px 18px;background:var(--success);color:#fff;border-radius:var(--radius-sm);font-size:.83rem;font-weight:500;z-index:100;transform:translateY(80px);opacity:0;transition:all .3s}
.toast.show{transform:translateY(0);opacity:1}.toast.error{background:var(--danger)}

/* ML Sections */
.ml-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px}
.ml-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.ml-panel.full{grid-column:1/-1}
.ml-panel h3{font-size:.92rem;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.ml-panel h3 .badge{font-size:.68rem;padding:2px 8px;border-radius:10px;background:var(--accent-glow);color:var(--accent);font-weight:500}
.score-bar{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.score-bar .bar-bg{flex:1;height:8px;background:var(--surface2);border-radius:4px;overflow:hidden}
.score-bar .bar-fill{height:100%;border-radius:4px;transition:width .5s}
.score-bar .label{font-size:.75rem;color:var(--text-dim);min-width:80px}
.score-bar .val{font-size:.78rem;font-weight:600;min-width:32px;text-align:right}
.ml-job{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid var(--border);font-size:.83rem}
.ml-job:last-child{border-bottom:none}
.ml-job .score-pill{min-width:36px;padding:3px 8px;border-radius:10px;font-size:.75rem;font-weight:700;text-align:center}
.ml-job .score-pill.high{background:rgba(39,174,96,.15);color:var(--success)}
.ml-job .score-pill.mid{background:rgba(243,156,18,.15);color:var(--warn)}
.ml-job .score-pill.low{background:rgba(231,76,60,.15);color:var(--danger)}
.ml-job .title{flex:1;font-weight:500}
.ml-job .company{color:var(--text-dim);font-size:.78rem}
.sug-item{padding:10px 14px;border-left:3px solid var(--accent);background:var(--surface2);border-radius:0 var(--radius-sm) var(--radius-sm) 0;margin-bottom:8px;font-size:.83rem}
.sug-item.warn{border-left-color:var(--warn)}
.sug-item.good{border-left-color:var(--success)}
.sug-item .kw{display:inline-block;padding:2px 8px;border-radius:8px;background:var(--accent-glow);color:var(--accent);font-family:'JetBrains Mono',monospace;font-size:.78rem;margin:0 3px}
.kw-rec{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid var(--border);font-size:.83rem}
.kw-rec:last-child{border-bottom:none}
.kw-rec .word{font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--accent)}
.kw-rec .conf{font-size:.72rem;padding:2px 6px;border-radius:8px}
.kw-rec .conf.high{background:rgba(39,174,96,.15);color:var(--success)}
.kw-rec .conf.mid{background:rgba(243,156,18,.15);color:var(--warn)}
.anomaly-item{padding:12px 16px;border-left:3px solid var(--warn);background:var(--surface2);border-radius:0 var(--radius-sm) var(--radius-sm) 0;margin-bottom:10px}
.anomaly-item.high{border-left-color:var(--danger)}
.anomaly-item.info{border-left-color:var(--accent)}
.anomaly-item .sev{display:inline-block;font-size:.68rem;padding:2px 6px;border-radius:8px;font-weight:600;margin-right:8px}
.anomaly-item .sev.high{background:rgba(231,76,60,.15);color:var(--danger)}
.anomaly-item .sev.medium{background:rgba(243,156,18,.15);color:var(--warn)}
.anomaly-item .sev.low{background:rgba(108,92,231,.15);color:var(--accent)}
.anomaly-item .sev.info{background:rgba(108,92,231,.1);color:var(--text-dim)}
.cluster-tag{display:inline-block;padding:3px 10px;border-radius:12px;background:var(--surface);border:1px solid var(--border);font-size:.78rem;margin:3px}
@media(max-width:768px){.chart-grid{grid-template-columns:1fr}.container{padding:16px 12px}.header{flex-direction:column;align-items:flex-start}}
</style>
</head>
<body>
<div class="noise"></div>

<div id="loginScreen" class="login-wrap">
  <div class="login-box">
    <h1><span>TA Monitor</span> ‚Äî Analytics</h1>
    <p>Accedi per visualizzare le analisi</p>
    <div class="field"><label>Username</label><input type="text" id="loginUser" autocomplete="username"/></div>
    <div class="field"><label>Password</label><input type="password" id="loginPass" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"/></div>
    <div class="error" id="loginError"></div>
    <button class="btn btn-primary" style="width:100%;padding:11px" onclick="doLogin()">Accedi</button>
  </div>
</div>

<div id="appScreen" style="display:none">
<div class="container">
  <div class="header">
    <h1>üìä <span>Analytics</span></h1>
    <div class="header-actions">
      <a href="./" class="btn btn-ghost">‚Üê Dashboard</a>
      <button class="btn btn-ghost" onclick="loadData()">‚Üª Aggiorna</button>
    </div>
  </div>

  <div class="profile-selector">
    <label>Profilo:</label>
    <select id="profileSelect" onchange="onProfileChange()"></select>
  </div>

  <div id="kpiSection"></div>
  <div id="chartSection"></div>
  <div id="mlSection"></div>
  <div id="insightSection"></div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
const REPO='FabioDeLuca1977/ta-monitor',PROFILES_PATH='profiles.json',USERS_PATH='users.json';
let token='',profilesData=null,usersData=null,currentUser=null,allJobs=[];

async function hashPw(p){const e=new TextEncoder().encode(p);const b=await crypto.subtle.digest('SHA-256',e);return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('')}

async function ghApi(p,o={}){
  const url=p.startsWith('https://')?p:`https://api.github.com/repos/${REPO}/${p}`;
  const r=await fetch(url,{...o,headers:{Authorization:`token ${token}`,Accept:'application/vnd.github.v3+json',...(o.headers||{})}});
  if(!r.ok)throw new Error(`GitHub ${r.status}`);return r.json()
}
async function ghGet(p){return ghApi(`contents/${p}`)}
function ghDecode(d){return JSON.parse(decodeURIComponent(escape(atob(d.content.replace(/\n/g,'')))))}

// Login
async function doLogin(){
  const u=$('loginUser').value.trim().toLowerCase(),p=$('loginPass').value,err=$('loginError');
  if(!u||!p){err.textContent='Inserisci credenziali';return}err.textContent='';
  const enc=localStorage.getItem('ta_token_enc');
  if(!enc){err.textContent='Accesso non configurato. Apri prima la dashboard principale.';return}
  try{token=atob(enc);const d=await ghGet(USERS_PATH);usersData=ghDecode(d);
    const h=await hashPw(p),f=usersData.users.find(x=>x.username===u&&x.password_hash===h);
    if(!f){err.textContent='Username o password errati';return}
    currentUser=f;localStorage.setItem('ta_user',u);showApp()
  }catch(e){err.textContent='Errore: '+e.message}
}
window.addEventListener('DOMContentLoaded',async()=>{
  const enc=localStorage.getItem('ta_token_enc'),su=localStorage.getItem('ta_user');
  if(enc&&su){token=atob(enc);try{const d=await ghGet(USERS_PATH);usersData=ghDecode(d);
    const f=usersData.users.find(x=>x.username===su);if(f){currentUser=f;showApp();return}}catch(e){}}
  $('loginScreen').style.display='flex'
});

async function showApp(){
  $('loginScreen').style.display='none';$('appScreen').style.display='block';
  await loadProfiles()
}

async function loadProfiles(){
  try{
    const d=await ghGet(PROFILES_PATH);profilesData=ghDecode(d);
    const sel=$('profileSelect');sel.innerHTML='';
    // Show hr-roma + user's own profiles (admin sees all)
    Object.entries(profilesData.profiles).forEach(([id,p])=>{
      if(id==='hr-roma'||p.created_by===currentUser.username||currentUser.role==='admin'){
        const opt=document.createElement('option');opt.value=id;opt.textContent=p.name;sel.appendChild(opt)
      }
    });
    await loadData()
  }catch(e){toast('Errore: '+e.message,true)}
}

function onProfileChange(){loadData()}

async function loadData(){
  const pid=$('profileSelect').value;if(!pid)return;
  $('kpiSection').innerHTML='<div class="loading"><div class="spinner"></div>Caricamento dati...</div>';
  $('chartSection').innerHTML='';$('insightSection').innerHTML='';
  try{
    // Load all available job files ‚Äî try profile subdir first, then root output
    let jobsDir='output';let files=[];
    try{
      files=await ghApi(`contents/output/${pid}`);
      jobsDir=`output/${pid}`;
    }catch(e){
      // Fallback to root output
      try{files=await ghApi('contents/output')}catch(e2){throw new Error('Cartella output non trovata')}
    }
    const jsonFiles=(Array.isArray(files)?files:[]).filter(f=>f.name.startsWith('ta_jobs_')&&f.name.endsWith('.json')).sort((a,b)=>a.name.localeCompare(b.name));

    allJobs=[];
    // Load last N files (max 10 for performance)
    const toLoad=jsonFiles.slice(-10);
    for(const f of toLoad){
      try{
        const d=await ghGet(`${jobsDir}/${f.name}`);
        const jobs=ghDecode(d);
        const dateMatch=f.name.match(/(\d{4}-\d{2}-\d{2})/);
        const scanDate=dateMatch?dateMatch[1]:'';
        jobs.forEach(j=>j._scan_date=scanDate);
        allJobs.push(...jobs)
      }catch(e){console.warn('Skip file:',f.name,e)}
    }

    // Also load summary
    let summary=null;
    try{const sd=await ghGet(`${jobsDir}/summary.json`);summary=ghDecode(sd)}catch(e){try{const sd=await ghGet('output/summary.json');summary=ghDecode(sd)}catch(e2){}}

    if(!allJobs.length){
      $('kpiSection').innerHTML='<div class="loading">Nessun dato disponibile per questo profilo</div>';
      return
    }

    renderKPIs(allJobs,summary);
    renderCharts(allJobs);
    renderInsights(allJobs);
    await loadMLInsights(pid,jobsDir);
    toast('Dati caricati: '+allJobs.length+' posizioni')
  }catch(e){
    $('kpiSection').innerHTML=`<div class="loading" style="color:var(--danger)">Errore: ${e.message}</div>`;
  }
}

// === KPIs ===
function renderKPIs(jobs,summary){
  // Deduplicate by title+company
  const unique=new Map();
  jobs.forEach(j=>{const k=`${(j.title||'').toLowerCase()}|${(j.company||'').toLowerCase()}`;if(!unique.has(k))unique.set(k,j)});
  const deduped=[...unique.values()];

  const companies=new Set(deduped.map(j=>j.company).filter(Boolean));
  const channels=new Set(deduped.map(j=>j.site||j.channel).filter(Boolean));

  // Date range
  const dates=deduped.map(j=>parseDate(j.date_posted)).filter(d=>d).sort((a,b)=>a-b);
  const daySpan=dates.length>=2?Math.ceil((dates[dates.length-1]-dates[0])/(86400000)):1;

  // Weekly rate
  const weeklyRate=daySpan>0?Math.round(deduped.length/(daySpan/7)*10)/10:deduped.length;

  // Fresh (last 7 days)
  const now=Date.now();
  const fresh=deduped.filter(j=>{const d=parseDate(j.date_posted);return d&&(now-d)<7*86400000}).length;

  $('kpiSection').innerHTML=`<div class="kpi-grid">
    <div class="kpi"><div class="num">${deduped.length}</div><div class="label">Posizioni totali</div></div>
    <div class="kpi"><div class="num">${companies.size}</div><div class="label">Aziende</div></div>
    <div class="kpi"><div class="num">${channels.size}</div><div class="label">Canali</div></div>
    <div class="kpi"><div class="num">${weeklyRate}</div><div class="label">Media / settimana</div></div>
    <div class="kpi"><div class="num" style="color:var(--success)">${fresh}</div><div class="label">Ultimi 7 giorni</div></div>
    <div class="kpi"><div class="num">${daySpan}</div><div class="label">Giorni monitorati</div></div>
  </div>`;
}

// === CHARTS ===
let chartRetries=0;
function renderCharts(jobs){
  if(typeof Chart==='undefined'){
    chartRetries++;
    if(chartRetries>10){
      $('chartSection').innerHTML='<div class="chart-panel full" style="text-align:center;padding:40px"><p style="color:var(--warn)">‚ö† Impossibile caricare i grafici (Chart.js bloccato)</p><p style="font-size:.8rem;color:var(--text-dim);margin-top:8px">Prova a disabilitare l\'ad-blocker o apri in finestra privata</p></div>';
      return;
    }
    setTimeout(()=>renderCharts(jobs),500);
    return;
  }
  chartRetries=0;
  const unique=dedup(jobs);

  $('chartSection').innerHTML=`
    <div class="chart-grid">
      <div class="chart-panel full"><h3>üìà Trend temporale</h3><div class="chart-wrap"><canvas id="trendChart"></canvas></div></div>
      <div class="chart-panel"><h3>üè¢ Top aziende</h3><div class="chart-wrap"><canvas id="companyChart"></canvas></div></div>
      <div class="chart-panel"><h3>üì° Canali</h3><div class="chart-wrap"><canvas id="channelChart"></canvas></div></div>
      <div class="chart-panel full"><h3>üè∑ Keyword nei titoli</h3><div class="chart-wrap"><canvas id="keywordChart"></canvas></div></div>
    </div>`;

  // Chart defaults
  Chart.defaults.color='#8888a0';
  Chart.defaults.borderColor='#2a2a3a';
  Chart.defaults.font.family="'DM Sans',sans-serif";

  buildTrendChart(unique);
  buildCompanyChart(unique);
  buildChannelChart(unique);
  buildKeywordChart(unique);
}

function buildTrendChart(jobs){
  // Group by date
  const byDate={};
  jobs.forEach(j=>{
    const d=parseDate(j.date_posted);
    if(!d)return;
    const key=d.toISOString().slice(0,10);
    byDate[key]=(byDate[key]||0)+1;
  });
  const sorted=Object.entries(byDate).sort((a,b)=>a[0].localeCompare(b[0]));
  if(!sorted.length)return;

  // Fill missing dates
  const start=new Date(sorted[0][0]),end=new Date(sorted[sorted.length-1][0]);
  const labels=[],data=[];
  for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
    const key=d.toISOString().slice(0,10);
    labels.push(key.slice(5));// MM-DD
    data.push(byDate[key]||0);
  }

  // 7-day moving average
  const ma=data.map((v,i)=>{
    const slice=data.slice(Math.max(0,i-6),i+1);
    return Math.round(slice.reduce((a,b)=>a+b,0)/slice.length*10)/10;
  });

  new Chart($('trendChart'),{
    type:'bar',
    data:{
      labels,
      datasets:[
        {label:'Annunci/giorno',data,backgroundColor:'rgba(108,92,231,0.4)',borderColor:'rgba(108,92,231,0.8)',borderWidth:1,borderRadius:4,order:2},
        {label:'Media mobile 7gg',data:ma,type:'line',borderColor:'#f39c12',borderWidth:2,pointRadius:0,tension:0.4,order:1}
      ]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:12,padding:16}}},scales:{x:{grid:{display:false}},y:{beginAtZero:true,ticks:{stepSize:1}}}}
  });
}

function buildCompanyChart(jobs){
  const counts={};
  jobs.forEach(j=>{const c=j.company||'Sconosciuta';counts[c]=(counts[c]||0)+1});
  const top=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,12);
  const maxVal=top.length?top[0][1]:1;

  new Chart($('companyChart'),{
    type:'bar',
    data:{
      labels:top.map(t=>t[0].length>25?t[0].slice(0,23)+'‚Ä¶':t[0]),
      datasets:[{data:top.map(t=>t[1]),backgroundColor:top.map((_,i)=>`hsla(${258-i*8},70%,${60+i*2}%,0.7)`),borderRadius:4}]
    },
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,ticks:{stepSize:1}},y:{grid:{display:false}}}}
  });
}

function buildChannelChart(jobs){
  const counts={};
  jobs.forEach(j=>{const s=(j.site||j.channel||'Altro').toLowerCase();counts[s]=(counts[s]||0)+1});
  const entries=Object.entries(counts).sort((a,b)=>b[1]-a[1]);

  const colors={'linkedin':'#0077b5','indeed':'#2e5aac','glassdoor':'#0caa41','google_jobs':'#ea4335','google':'#ea4335'};
  const defaultColors=['#6c5ce7','#e17055','#00b894','#fdcb6e','#74b9ff'];

  new Chart($('channelChart'),{
    type:'doughnut',
    data:{
      labels:entries.map(e=>e[0]),
      datasets:[{data:entries.map(e=>e[1]),backgroundColor:entries.map((e,i)=>colors[e[0]]||defaultColors[i%defaultColors.length]),borderWidth:0}]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:12,padding:12}}}}
  });
}

function buildKeywordChart(jobs){
  // Extract frequent words from titles
  const stopWords=new Set(['di','del','della','delle','dei','e','a','in','per','la','il','lo','le','un','una','the','and','or','for','to','at','of','with','on','is','an','-','‚Äì','‚Äî','&','|','/','da','al','alla','con','su','che','non','si','√®']);
  const wordCounts={};
  jobs.forEach(j=>{
    const title=(j.title||'').toLowerCase();
    title.split(/[\s\-\/\(\)\,\.\:\;\&]+/).forEach(w=>{
      w=w.trim();
      if(w.length>2&&!stopWords.has(w)&&!/^\d+$/.test(w)){wordCounts[w]=(wordCounts[w]||0)+1}
    });
  });
  const top=Object.entries(wordCounts).sort((a,b)=>b[1]-a[1]).slice(0,20);

  new Chart($('keywordChart'),{
    type:'bar',
    data:{
      labels:top.map(t=>t[0]),
      datasets:[{data:top.map(t=>t[1]),backgroundColor:'rgba(108,92,231,0.5)',borderColor:'rgba(108,92,231,0.8)',borderWidth:1,borderRadius:4}]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true,ticks:{stepSize:1}}}}
  });
}

// === INSIGHTS (basic, from job data) ===
function renderInsights(jobs){
  const unique=dedup(jobs);
  const insights=[];

  // 1. Trend direction
  const byDate={};
  unique.forEach(j=>{const d=parseDate(j.date_posted);if(d){const k=d.toISOString().slice(0,10);byDate[k]=(byDate[k]||0)+1}});
  const dates=Object.keys(byDate).sort();
  if(dates.length>=7){
    const recent=dates.slice(-7).reduce((s,k)=>s+(byDate[k]||0),0);
    const prev=dates.slice(-14,-7).reduce((s,k)=>s+(byDate[k]||0),0);
    if(prev>0){
      const change=Math.round((recent-prev)/prev*100);
      if(change>20)insights.push({type:'trend',text:`üìà Mercato in crescita: <strong>+${change}%</strong> annunci rispetto alla settimana precedente (${recent} vs ${prev})`});
      else if(change<-20)insights.push({type:'alert',text:`üìâ Mercato in calo: <strong>${change}%</strong> annunci rispetto alla settimana precedente (${recent} vs ${prev})`});
      else insights.push({type:'trend',text:`‚û°Ô∏è Mercato stabile: variazione ${change>0?'+':''}${change}% rispetto alla settimana precedente`});
    }
  }

  // 2. Top growing company
  const compByDate={};
  unique.forEach(j=>{
    const d=parseDate(j.date_posted);if(!d)return;
    const week=getWeek(d);const c=j.company||'';
    if(!compByDate[c])compByDate[c]={};
    compByDate[c][week]=(compByDate[c][week]||0)+1;
  });
  const recentWeek=dates.length?getWeek(new Date(dates[dates.length-1])):'';
  if(recentWeek){
    let maxComp='',maxCount=0;
    Object.entries(compByDate).forEach(([comp,weeks])=>{
      const cnt=weeks[recentWeek]||0;
      if(cnt>maxCount&&comp){maxCount=cnt;maxComp=comp}
    });
    if(maxComp&&maxCount>=2)insights.push({type:'opportunity',text:`üè¢ <strong>${maxComp}</strong> sta assumendo attivamente: ${maxCount} posizioni questa settimana`});
  }

  // 3. Channel dominance
  const chCounts={};
  unique.forEach(j=>{const s=(j.site||'').toLowerCase();if(s)chCounts[s]=(chCounts[s]||0)+1});
  const topCh=Object.entries(chCounts).sort((a,b)=>b[1]-a[1]);
  if(topCh.length>=2){
    const pct=Math.round(topCh[0][1]/unique.length*100);
    insights.push({type:'trend',text:`üì° <strong>${topCh[0][0]}</strong> domina con il ${pct}% degli annunci. Secondo canale: ${topCh[1][0]} (${Math.round(topCh[1][1]/unique.length*100)}%)`});
  }

  // 4. New companies appearing
  const now=Date.now();
  const recentJobs=unique.filter(j=>{const d=parseDate(j.date_posted);return d&&(now-d)<7*86400000});
  const oldJobs=unique.filter(j=>{const d=parseDate(j.date_posted);return d&&(now-d)>=7*86400000});
  const oldCompanies=new Set(oldJobs.map(j=>(j.company||'').toLowerCase()));
  const newCompanies=[...new Set(recentJobs.map(j=>j.company).filter(c=>c&&!oldCompanies.has(c.toLowerCase())))];
  if(newCompanies.length>0&&newCompanies.length<=5){
    insights.push({type:'opportunity',text:`üÜï Nuove aziende questa settimana: <strong>${newCompanies.join(', ')}</strong>`});
  }else if(newCompanies.length>5){
    insights.push({type:'opportunity',text:`üÜï <strong>${newCompanies.length}</strong> nuove aziende questa settimana (mercato dinamico)`});
  }

  // 5. Keyword concentration
  const titleWords={};
  unique.forEach(j=>{
    const words=(j.title||'').toLowerCase().match(/[a-z√†√®√©√¨√≤√π]{3,}/g)||[];
    words.forEach(w=>titleWords[w]=(titleWords[w]||0)+1);
  });
  const topKw=Object.entries(titleWords).sort((a,b)=>b[1]-a[1]).slice(0,3);
  if(topKw.length){
    insights.push({type:'trend',text:`üè∑ Termini pi√π frequenti nei titoli: ${topKw.map(([w,c])=>`<strong>${w}</strong> (${c})`).join(', ')}`});
  }

  // Render
  if(!insights.length)insights.push({type:'trend',text:'Dati insufficienti per generare insights. Continua a monitorare!'});
  $('insightSection').innerHTML=`<div class="insights"><h3>üí° Insights automatici</h3>
    ${insights.map(i=>`<div class="insight-item ${i.type==='alert'?'warn':i.type==='opportunity'?'good':''}">
      <span class="tag ${i.type}">${i.type==='trend'?'TREND':i.type==='alert'?'ALERT':'OPPORTUNIT√Ä'}</span>${i.text}
    </div>`).join('')}
  </div>`;
}

// === ML INSIGHTS ===
async function loadMLInsights(pid,jobsDir){
  $('mlSection').innerHTML='';
  let ml=null;
  try{
    const d=await ghGet(`${jobsDir}/ml_insights.json`);
    ml=ghDecode(d)
  }catch(e){
    try{const d=await ghGet('output/ml_insights.json');ml=ghDecode(d)}catch(e2){}
  }
  if(!ml){
    $('mlSection').innerHTML='<div class="ml-panel full" style="text-align:center;padding:20px"><p style="color:var(--text-dim)">üß† ML Insights non ancora disponibili. Verranno generati al prossimo scan.</p></div>';
    return
  }
  renderML(ml)
}

function renderML(ml){
  const s=ml.scoring||{};const dist=s.distribution||{};const topJobs=s.top_jobs||[];
  const filt=ml.filter_suggestions||{};
  const kwRecs=ml.keyword_recommendations||[];
  const anomalies=ml.anomalies||[];

  let html='<div class="ml-grid">';

  // --- Score Distribution ---
  const total=Object.values(dist).reduce((a,b)=>a+b,0)||1;
  html+=`<div class="ml-panel">
    <h3>üéØ Score Rilevanza <span class="badge">Media: ${s.average||0}</span></h3>
    <div class="score-bar"><span class="label">üü¢ Eccellente</span><div class="bar-bg"><div class="bar-fill" style="width:${(dist.excellent||0)/total*100}%;background:var(--success)"></div></div><span class="val">${dist.excellent||0}</span></div>
    <div class="score-bar"><span class="label">üîµ Buono</span><div class="bar-bg"><div class="bar-fill" style="width:${(dist.good||0)/total*100}%;background:var(--accent)"></div></div><span class="val">${dist.good||0}</span></div>
    <div class="score-bar"><span class="label">üü° Medio</span><div class="bar-bg"><div class="bar-fill" style="width:${(dist.medium||0)/total*100}%;background:var(--warn)"></div></div><span class="val">${dist.medium||0}</span></div>
    <div class="score-bar"><span class="label">üü† Basso</span><div class="bar-bg"><div class="bar-fill" style="width:${(dist.low||0)/total*100}%;background:#e67e22"></div></div><span class="val">${dist.low||0}</span></div>
    <div class="score-bar"><span class="label">üî¥ Irrilevante</span><div class="bar-bg"><div class="bar-fill" style="width:${(dist.irrelevant||0)/total*100}%;background:var(--danger)"></div></div><span class="val">${dist.irrelevant||0}</span></div>
  </div>`;

  // --- Top Scored Jobs ---
  html+=`<div class="ml-panel">
    <h3>‚≠ê Top posizioni per rilevanza</h3>
    ${topJobs.slice(0,8).map(j=>{
      const sc=j.score||0;const cls=sc>=80?'high':sc>=50?'mid':'low';
      const url=j.url||'';
      return `<div class="ml-job">
        <span class="score-pill ${cls}">${sc}</span>
        <span class="title">${esc(j.title||'')}</span>
        <span class="company">${esc(j.company||'')}</span>
        ${url?`<a href="${url}" target="_blank" rel="noopener" style="color:var(--accent);font-size:.78rem">‚Üó</a>`:''}
      </div>`
    }).join('')}
  </div>`;

  // --- Keyword Recommendations ---
  if(kwRecs.length){
    html+=`<div class="ml-panel">
      <h3>üîë Keyword suggerite <span class="badge">${kwRecs.length}</span></h3>
      ${kwRecs.map(r=>{
        const cls=r.confidence>=70?'high':'mid';
        return `<div class="kw-rec">
          <span class="word">${esc(r.keyword)}</span>
          <span style="flex:1;font-size:.78rem;color:var(--text-dim)">freq: ${r.frequency}x</span>
          <span class="conf ${cls}">${r.confidence}%</span>
        </div>`
      }).join('')}
    </div>`;
  }

  // --- Filter Suggestions ---
  const addRel=filt.add_relevant||[];const addBl=filt.add_blacklist||[];const review=filt.review||[];
  if(addRel.length||addBl.length||review.length){
    html+=`<div class="ml-panel">
      <h3>üîß Suggerimenti filtri</h3>
      ${addRel.length?`<p style="font-size:.78rem;color:var(--text-dim);margin-bottom:8px">Annunci ad alto score senza pattern match ‚Äî considera di aggiungere pattern:</p>
        ${addRel.map(s=>`<div class="sug-item good"><strong>${esc(s.title)}</strong> <span style="font-size:.75rem;color:var(--text-dim)">(score: ${s.score})</span></div>`).join('')}`:''}
      ${addBl.length?`<p style="font-size:.78rem;color:var(--text-dim);margin:12px 0 8px">Parole frequenti in annunci a basso score ‚Äî possibili blacklist:</p>
        ${addBl.map(s=>`<div class="sug-item warn"><span class="kw">${esc(s.word)}</span> ${s.count}x ‚Äî ${esc(s.reason)}</div>`).join('')}`:''}
      ${review.length?`<p style="font-size:.78rem;color:var(--text-dim);margin:12px 0 8px">Possibili falsi positivi da verificare:</p>
        ${review.map(s=>`<div class="sug-item"><strong>${esc(s.title)}</strong> <span style="font-size:.75rem;color:var(--text-dim)">(score: ${s.score}, pattern: ${esc(s.pattern)})</span></div>`).join('')}`:''}
    </div>`;
  }

  // --- Anomaly Detection ---
  if(anomalies.length){
    html+=`<div class="ml-panel full">
      <h3>üö® Anomalie e segnalazioni</h3>
      ${anomalies.map(a=>{
        const sevCls=a.severity||'medium';
        const itemCls=sevCls==='high'?'high':sevCls==='info'?'info':'';
        let extra='';
        if(a.type==='role_clusters'&&a.data&&a.data.clusters){
          extra='<div style="margin-top:8px">'+a.data.clusters.map(c=>
            `<div style="margin-bottom:6px"><span style="font-size:.78rem;color:var(--text-dim)">Cluster ${c.id+1} (${c.pct}%):</span> ${c.top_terms.map(t=>`<span class="cluster-tag">${esc(t)}</span>`).join('')}</div>`
          ).join('')+'</div>';
        }
        return `<div class="anomaly-item ${itemCls}">
          <span class="sev ${sevCls}">${sevCls.toUpperCase()}</span>
          ${a.message}${extra}
        </div>`
      }).join('')}
    </div>`;
  }

  html+='</div>';
  $('mlSection').innerHTML=html;
}

// === HELPERS ===
function dedup(jobs){
  const m=new Map();
  jobs.forEach(j=>{const k=`${(j.title||'').toLowerCase()}|${(j.company||'').toLowerCase()}`;if(!m.has(k))m.set(k,j)});
  return [...m.values()];
}

function parseDate(raw){
  if(!raw||raw==='None'||raw==='NaT'||raw==='nan'||raw==='')return null;
  const num=Number(raw);
  if(!isNaN(num)&&num>1e9)return new Date(num>1e12?num:num*1000);
  if(typeof raw==='string'&&raw.length>=10){const d=new Date(raw.slice(0,10));if(!isNaN(d))return d}
  return null;
}

function getWeek(d){
  const start=new Date(d.getFullYear(),0,1);
  const diff=d-start;
  return `${d.getFullYear()}-W${String(Math.ceil(diff/604800000)).padStart(2,'0')}`;
}

function $(id){return document.getElementById(id)}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function toast(m,e){const t=$('toast');t.textContent=m;t.className='toast show'+(e?' error':'');setTimeout(()=>t.className='toast',3000)}
</script>
</body>
</html>