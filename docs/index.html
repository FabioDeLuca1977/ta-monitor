<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TA Monitor ‚Äî Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0f;--surface:#13131a;--surface2:#1a1a24;--border:#2a2a3a;--border-focus:#6c5ce7;--text:#e8e8f0;--text-dim:#8888a0;--accent:#6c5ce7;--accent-hover:#7d6ff0;--accent-glow:rgba(108,92,231,.15);--danger:#e74c3c;--success:#27ae60;--success-glow:rgba(39,174,96,.15);--warn:#f39c12;--tag-bg:#1e1e2e;--tag-border:#3a3a50;--radius:10px;--radius-sm:6px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}
.noise{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.03;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}
.container{position:relative;z-index:1;max-width:1000px;margin:0 auto;padding:32px 24px}
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;width:100%;max-width:400px;text-align:center}
.login-box h1{font-size:1.4rem;margin-bottom:6px}.login-box h1 span{color:var(--accent)}
.login-box p{color:var(--text-dim);font-size:.85rem;margin-bottom:28px}
.field{margin-bottom:16px;text-align:left}.field label{display:block;font-size:.8rem;color:var(--text-dim);margin-bottom:4px}
.field input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;color:var(--text);font-family:inherit;font-size:.9rem}
.field input:focus{outline:none;border-color:var(--border-focus)}
.error{color:var(--danger);font-size:.82rem;margin-bottom:12px;min-height:20px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.header h1{font-size:1.4rem;font-weight:700}.header h1 span{color:var(--accent)}
.header-actions{display:flex;gap:8px;align-items:center}
.user-info{display:flex;align-items:center;gap:6px;font-size:.8rem;color:var(--text-dim)}
.user-info .avatar{width:26px;height:26px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:.72rem}
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:.83rem;font-weight:500;cursor:pointer;transition:all .2s}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:var(--accent-hover)}
.btn-danger{background:transparent;color:var(--danger);border:1px solid var(--danger)}.btn-danger:hover{background:var(--danger);color:#fff}
.btn-ghost{background:transparent;color:var(--text-dim);border:1px solid var(--border)}.btn-ghost:hover{color:var(--text)}
.btn-save{background:var(--success);color:#fff;padding:8px 20px}.btn-save:disabled{opacity:.4;cursor:not-allowed}
.btn-run{background:var(--warn);color:#000;padding:8px 18px;font-weight:600}.btn-run:hover{background:#e67e22}.btn-run:disabled{opacity:.4;cursor:not-allowed}

/* PROFILE TABS */
.profile-bar{display:flex;gap:6px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
.profile-tab{padding:8px 16px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-dim);cursor:pointer;font-family:inherit;font-size:.83rem;transition:all .2s;display:flex;align-items:center;gap:6px}
.profile-tab:hover{border-color:var(--text-dim)}
.profile-tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.profile-tab .auto-dot{width:7px;height:7px;border-radius:50%;background:var(--success)}
.profile-tab .auto-dot.off{background:var(--border)}
.profile-add{padding:8px 14px;border-radius:20px;border:1px dashed var(--border);background:transparent;color:var(--text-dim);cursor:pointer;font-family:inherit;font-size:.83rem}
.profile-add:hover{border-color:var(--accent);color:var(--accent)}

/* PROFILE HEADER */
.profile-header{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.profile-meta{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.profile-meta .name{font-size:1.1rem;font-weight:600}
.profile-meta .loc{font-size:.82rem;color:var(--text-dim)}
.profile-actions{display:flex;gap:8px;align-items:center}
/* Toggle */
.toggle{position:relative;width:44px;height:24px;cursor:pointer;display:flex;align-items:center}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{position:absolute;inset:0;background:var(--border);border-radius:12px;transition:.3s}
.toggle .slider:before{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;left:3px;bottom:3px;transition:.3s}
.toggle input:checked+.slider{background:var(--success)}
.toggle input:checked+.slider:before{transform:translateX(20px)}
.toggle-label{font-size:.78rem;color:var(--text-dim);margin-left:6px}

.section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:20px;overflow:hidden}
.section-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;cursor:pointer;user-select:none;border-bottom:1px solid transparent}
.section-header.open{border-bottom-color:var(--border)}
.section-header h2{font-size:.95rem;font-weight:600;display:flex;align-items:center;gap:8px}
.section-header .count{background:var(--accent-glow);color:var(--accent);padding:2px 8px;border-radius:20px;font-size:.72rem}
.section-header .chevron{width:18px;height:18px;color:var(--text-dim);transition:transform .3s}
.section-header.open .chevron{transform:rotate(180deg)}
.section-body{padding:18px;display:none}.section-body.open{display:block}
.tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px}
.tag{display:inline-flex;align-items:center;gap:5px;background:var(--tag-bg);border:1px solid var(--tag-border);border-radius:20px;padding:4px 11px 4px 13px;font-size:.8rem;animation:tagIn .2s ease}
@keyframes tagIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
.tag .remove{width:15px;height:15px;border-radius:50%;border:none;background:transparent;color:var(--text-dim);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.65rem}.tag .remove:hover{background:var(--danger);color:#fff}
.add-row{display:flex;gap:6px;margin-top:6px}
.add-row input,.add-row select{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:7px 10px;color:var(--text);font-family:inherit;font-size:.83rem}
.add-row input{flex:1}.add-row select{width:170px}
.add-row input:focus,.add-row select:focus{outline:none;border-color:var(--border-focus)}
.pattern-table{width:100%;border-collapse:collapse}.pattern-table th{text-align:left;padding:6px 10px;font-size:.72rem;color:var(--text-dim);text-transform:uppercase;border-bottom:1px solid var(--border)}
.pattern-table td{padding:6px 10px;border-bottom:1px solid var(--border);font-size:.82rem;vertical-align:middle}
.pattern-table .mono{font-family:'JetBrains Mono',monospace;font-size:.75rem;color:var(--accent);word-break:break-all}
.pattern-table .cat{background:var(--tag-bg);border:1px solid var(--tag-border);padding:2px 8px;border-radius:10px;font-size:.72rem;white-space:nowrap}
.run-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:20px}
.run-panel h2{font-size:1rem;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.run-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
.run-status{display:inline-flex;align-items:center;gap:5px;padding:3px 12px;border-radius:20px;font-size:.78rem;font-weight:500}
.run-status.success{background:var(--success-glow);color:var(--success)}.run-status.running{background:rgba(108,92,231,.15);color:var(--accent)}.run-status.failed{background:rgba(231,76,60,.15);color:var(--danger)}.run-status.queued{background:rgba(243,156,18,.15);color:var(--warn)}
.run-status .dot{width:7px;height:7px;border-radius:50%;background:currentColor}.run-status.running .dot{animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.run-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:16px}
.run-stat{background:var(--surface2);border-radius:var(--radius-sm);padding:10px 14px;text-align:center}
.run-stat .num{font-size:1.4rem;font-weight:700;color:var(--accent)}.run-stat .label{font-size:.72rem;color:var(--text-dim)}
.results-table{width:100%;border-collapse:collapse;font-size:.82rem}
.results-table th{text-align:left;padding:8px 10px;font-size:.72rem;color:var(--text-dim);text-transform:uppercase;border-bottom:2px solid var(--border);position:sticky;top:0;background:var(--surface)}
.results-table td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:top}
.results-table tr:hover td{background:var(--surface2)}
.results-wrap{max-height:500px;overflow-y:auto;border-radius:var(--radius-sm)}
.channel-badge{display:inline-block;padding:2px 7px;border-radius:10px;font-size:.7rem;font-weight:500;text-transform:uppercase}
.channel-badge.linkedin{background:rgba(0,119,181,.2);color:#0077b5}.channel-badge.indeed{background:rgba(46,90,172,.2);color:#2e5aac}.channel-badge.glassdoor{background:rgba(12,170,65,.2);color:#0caa41}.channel-badge.google{background:rgba(234,67,53,.2);color:#ea4335}
.link-btn{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:var(--accent);color:#fff;text-decoration:none;font-size:.8rem}
.link-btn:hover{background:var(--accent-hover)}
.admin-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:20px}
.admin-panel h2{font-size:.95rem;font-weight:600;margin-bottom:14px}
.user-row{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;border-bottom:1px solid var(--border)}.user-row:last-child{border-bottom:none}
.toast{position:fixed;bottom:24px;right:24px;padding:10px 18px;background:var(--success);color:#fff;border-radius:var(--radius-sm);font-size:.83rem;font-weight:500;z-index:100;transform:translateY(80px);opacity:0;transition:all .3s}
.toast.show{transform:translateY(0);opacity:1}.toast.error{background:var(--danger)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:50;display:flex;align-items:center;justify-content:center;padding:24px}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:28px;max-width:480px;width:100%}
.modal h2{font-size:1.1rem;margin-bottom:16px}
@media(max-width:640px){.container{padding:16px 12px}.header{flex-direction:column;gap:12px;align-items:flex-start}.add-row{flex-direction:column}.add-row select{width:100%}.profile-bar{flex-direction:column}.run-controls{flex-direction:column;align-items:stretch}}
</style>
</head>
<body>
<div class="noise"></div>

<div id="loginScreen" class="login-wrap">
  <div class="login-box">
    <h1><span>TA Monitor</span></h1>
    <p>Accedi per gestire filtri e monitoraggio</p>
    <div class="field"><label>Username</label><input type="text" id="loginUser" autocomplete="username"/></div>
    <div class="field"><label>Password</label><input type="password" id="loginPass" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"/></div>
    <div class="error" id="loginError"></div>
    <button class="btn btn-primary" style="width:100%;padding:11px" onclick="doLogin()">Accedi</button>
    <div style="margin-top:18px;border-top:1px solid var(--border);padding-top:14px">
      <button class="btn btn-ghost" style="width:100%;font-size:.8rem" onclick="showSetup()">üë§ Crea nuovo utente</button>
    </div>
  </div>
</div>

<div id="setupScreen" class="login-wrap" style="display:none">
  <div class="login-box" style="max-width:480px">
    <h1>üë§ Crea nuovo utente</h1>
    <p>Inserisci il token GitHub e scegli username e password</p>
    <div class="field"><label>GitHub Token</label><input type="password" id="setupToken" placeholder="ghp_xxxxx"/></div>
    <div class="field"><label>Username Admin</label><input type="text" id="setupUser" placeholder="admin"/></div>
    <div class="field"><label>Password Admin</label><input type="password" id="setupPass" placeholder="min 6 caratteri"/></div>
    <div class="error" id="setupError"></div>
    <button class="btn btn-primary" style="width:100%;padding:11px" onclick="doSetup()">‚úì Crea utente</button>
    <button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="hideSetup()">‚Üê Torna</button>
  </div>
</div>

<div id="appScreen" style="display:none">
<div class="container">
  <div class="header">
    <h1><span>TA Monitor</span></h1>
    <div class="header-actions">
      <div class="user-info"><div class="avatar" id="userAvatar"></div><span id="userName"></span></div>
      <button class="btn btn-save" id="saveBtn" disabled onclick="saveAll()">üíæ Salva</button>
      <button class="btn btn-ghost" onclick="doLogout()" style="font-size:.78rem">Esci</button>
    </div>
  </div>
  <div id="profileBar" class="profile-bar"></div>
  <div id="profileHeader"></div>
  <div id="content"></div>
  <div id="runSection"></div>
  <div id="adminSection"></div>
</div>
</div>

<div class="toast" id="toast"></div>
<div id="modalRoot"></div>

<script>
const REPO='FabioDeLuca1977/ta-monitor',PROFILES_PATH='profiles.json',USERS_PATH='users.json',CONFIG_PATH='config.yaml',WF='ta-scan.yml';
let token='',profilesData=null,profilesSha='',usersData=null,usersSha='',currentUser=null,activeProfileId=null,dirty=false,pollTimer=null;

// Hash
async function hashPw(p){const e=new TextEncoder().encode(p);const b=await crypto.subtle.digest('SHA-256',e);return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('')}

// GitHub API
async function ghApi(p,o={}){const r=await fetch(`https://api.github.com/repos/${REPO}/${p}`,{...o,headers:{Authorization:`token ${token}`,Accept:'application/vnd.github.v3+json',...o.headers}});if(!r.ok)throw new Error(`GitHub ${r.status}`);return r.json()}
async function ghGet(p){return ghApi(`contents/${p}`)}
async function ghPut(p,c,s,m){return fetch(`https://api.github.com/repos/${REPO}/contents/${p}`,{method:'PUT',headers:{Authorization:`token ${token}`,Accept:'application/vnd.github.v3+json','Content-Type':'application/json'},body:JSON.stringify({message:m,content:btoa(unescape(encodeURIComponent(c))),sha:s})}).then(r=>{if(!r.ok)throw new Error(`PUT ${r.status}`);return r.json()})}
function ghDecode(d){return JSON.parse(decodeURIComponent(escape(atob(d.content.replace(/\n/g,'')))))}

// Auth
function showSetup(){$('loginScreen').style.display='none';$('setupScreen').style.display='flex'}
function hideSetup(){$('setupScreen').style.display='none';$('loginScreen').style.display='flex'}
async function doSetup(){
  const tk=$('setupToken').value.trim(),u=$('setupUser').value.trim().toLowerCase(),p=$('setupPass').value,err=$('setupError');
  if(!tk||!u||!p){err.textContent='Compila tutti i campi';return}if(p.length<6){err.textContent='Password min 6 caratteri';return}err.textContent='';
  try{token=tk;await ghApi('');
    const h=await hashPw(p),users={users:[{username:u,password_hash:h,role:'admin',created:new Date().toISOString()}]};
    let s='';try{s=(await ghGet(USERS_PATH)).sha}catch(e){}
    const r=await ghPut(USERS_PATH,JSON.stringify(users,null,2),s,'üîê Setup utenti');usersSha=r.content.sha;usersData=users;
    localStorage.setItem('ta_token_enc',btoa(tk));localStorage.setItem('ta_user',u);
    currentUser={username:u,role:'admin'};showApp();toast('‚úì Setup completato!')
  }catch(e){err.textContent='Errore: '+e.message}
}
async function doLogin(){
  const u=$('loginUser').value.trim().toLowerCase(),p=$('loginPass').value,err=$('loginError');
  if(!u||!p){err.textContent='Inserisci credenziali';return}err.textContent='';
  const enc=localStorage.getItem('ta_token_enc');if(!enc){err.textContent='Nessun setup su questo browser. Usa Setup Iniziale.';return}
  try{token=atob(enc);const d=await ghGet(USERS_PATH);usersSha=d.sha;usersData=ghDecode(d);
    const h=await hashPw(p),f=usersData.users.find(x=>x.username===u&&x.password_hash===h);
    if(!f){err.textContent='Credenziali errate';return}
    currentUser=f;localStorage.setItem('ta_user',u);showApp();toast('Benvenuto, '+u+'!')
  }catch(e){err.textContent='Errore: '+e.message}
}
function doLogout(){currentUser=null;localStorage.removeItem('ta_user');$('appScreen').style.display='none';$('loginScreen').style.display='flex';$('loginUser').value='';$('loginPass').value=''}
window.addEventListener('DOMContentLoaded',async()=>{
  const enc=localStorage.getItem('ta_token_enc'),su=localStorage.getItem('ta_user');
  if(enc&&su){token=atob(enc);try{const d=await ghGet(USERS_PATH);usersSha=d.sha;usersData=ghDecode(d);
    const f=usersData.users.find(x=>x.username===su);if(f){currentUser=f;showApp();return}}catch(e){}}
  $('loginScreen').style.display='flex'
});

// App
async function showApp(){
  $('loginScreen').style.display='none';$('setupScreen').style.display='none';$('appScreen').style.display='block';
  $('userAvatar').textContent=currentUser.username[0].toUpperCase();$('userName').textContent=currentUser.username;
  await loadProfiles()
}
async function loadProfiles(){
  try{const d=await ghGet(PROFILES_PATH);profilesSha=d.sha;profilesData=ghDecode(d);
    const ids=Object.keys(profilesData.profiles);activeProfileId=activeProfileId||ids[0]||null;
    renderProfileBar();if(activeProfileId)selectProfile(activeProfileId);toast('Caricato')
  }catch(e){toast('Errore: '+e.message,true)}
}

// Profile bar
function renderProfileBar(){
  const ps=profilesData.profiles;
  $('profileBar').innerHTML=Object.entries(ps).map(([id,p])=>`<button class="profile-tab${id===activeProfileId?' active':''}" onclick="selectProfile('${id}')"><span class="auto-dot${p.auto_scan?'':' off'}"></span>${esc(p.name)}</button>`).join('')+`<button class="profile-add" onclick="showNewProfileModal()">+ Nuovo profilo</button>`;
}

function selectProfile(id){
  activeProfileId=id;renderProfileBar();
  const p=profilesData.profiles[id];renderProfileHeader(id,p);renderFilters(p);renderRunSection(id);
  if(currentUser.role==='admin')renderAdmin();
}

function renderProfileHeader(id,p){
  $('profileHeader').innerHTML=`<div class="profile-header">
    <div class="profile-meta"><span class="name">${esc(p.name)}</span><span class="loc">üìç ${esc(p.location)}</span></div>
    <div class="profile-actions">
      <label class="toggle"><input type="checkbox" ${p.auto_scan?'checked':''} onchange="toggleAutoScan('${id}',this.checked)"/><span class="slider"></span></label>
      <span class="toggle-label">Cron auto</span>
      <button class="btn btn-ghost" style="font-size:.78rem" onclick="cloneProfile('${id}')">üìã Clona</button>
      ${id!=='hr-roma'?`<button class="btn btn-danger" style="font-size:.78rem;padding:5px 10px" onclick="deleteProfile('${id}')">üóë</button>`:''}
    </div>
  </div>`;
}

function toggleAutoScan(id,v){profilesData.profiles[id].auto_scan=v;markDirty();renderProfileBar()}

// New / Clone profile
function showNewProfileModal(cloneFrom){
  const src=cloneFrom?profilesData.profiles[cloneFrom]:null;
  $('modalRoot').innerHTML=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal">
    <h2>${src?'Clona profilo':'Nuovo profilo'}</h2>
    <div class="field"><label>Nome</label><input id="mpName" value="${src?esc(src.name)+' (copia)':''}"/></div>
    <div class="field"><label>Location</label><input id="mpLoc" value="${src?esc(src.location):'Roma, Lazio, Italia'}"/></div>
    <div class="field"><label>ID (slug, senza spazi)</label><input id="mpId" placeholder="es. data-analyst-mi"/></div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-primary" onclick="createProfile('${cloneFrom||''}')">Crea</button>
      <button class="btn btn-ghost" onclick="closeModal()">Annulla</button>
    </div>
  </div></div>`;
}
function cloneProfile(id){showNewProfileModal(id)}
function closeModal(){$('modalRoot').innerHTML=''}
function createProfile(cloneId){
  const name=$('mpName').value.trim(),loc=$('mpLoc').value.trim(),id=$('mpId').value.trim().toLowerCase().replace(/\s+/g,'-');
  if(!name||!id){toast('Compila nome e ID',true);return}
  if(profilesData.profiles[id]){toast('ID gi√† esistente',true);return}
  let filters;
  if(cloneId&&profilesData.profiles[cloneId]){filters=JSON.parse(JSON.stringify(profilesData.profiles[cloneId].filters))}
  else{filters={search_terms:[],relevant_patterns:[],broad_keywords:[],blacklist:[],agencies:[]}}
  profilesData.profiles[id]={name,description:'',auto_scan:false,location:loc,hours_old:168,created:new Date().toISOString(),created_by:currentUser.username,filters};
  closeModal();markDirty();renderProfileBar();selectProfile(id);toast('Profilo creato!')
}
function deleteProfile(id){
  if(!confirm(`Eliminare il profilo "${profilesData.profiles[id].name}"?`))return;
  delete profilesData.profiles[id];markDirty();
  activeProfileId=Object.keys(profilesData.profiles)[0];renderProfileBar();
  if(activeProfileId)selectProfile(activeProfileId);toast('Profilo eliminato')
}

// Save
async function saveAll(){
  if(!profilesData)return;
  try{$('saveBtn').disabled=true;$('saveBtn').textContent='‚è≥...';
    profilesData._updated=new Date().toISOString();profilesData._updated_by=currentUser.username;
    const r=await ghPut(PROFILES_PATH,JSON.stringify(profilesData,null,2),profilesSha,`‚öôÔ∏è Profili aggiornati da ${currentUser.username}`);
    profilesSha=r.content.sha;dirty=false;$('saveBtn').disabled=true;$('saveBtn').textContent='üíæ Salva';toast('‚úì Salvato')
  }catch(e){toast('Errore: '+e.message,true);$('saveBtn').disabled=false;$('saveBtn').textContent='üíæ Salva'}
}
function markDirty(){dirty=true;$('saveBtn').disabled=false}

// Filters
function F(){return profilesData.profiles[activeProfileId].filters}
function renderFilters(p){
  const f=p.filters;
  $('content').innerHTML=[
    sec('keywords','üîç Keywords',f.search_terms.length),
    sec('relevant','‚úì Pattern Rilevanza',f.relevant_patterns.length),
    sec('broad','üìã Keywords Broad',f.broad_keywords.length),
    sec('blacklist','‚úó Blacklist',f.blacklist.length),
    sec('agencies','üè¢ Agenzie',f.agencies.length)
  ].join('');
  rKeywords();rRelevant();rBroad();rBlacklist();rAgencies();toggle('keywords')
}
function sec(id,t,n){return `<div class="section" id="sec-${id}"><div class="section-header" onclick="toggle('${id}')"><h2>${t} <span class="count">${n}</span></h2><svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div><div class="section-body" id="body-${id}"></div></div>`}
function toggle(id){document.querySelector(`#sec-${id} .section-header`).classList.toggle('open');$(`body-${id}`).classList.toggle('open')}

function rKeywords(){$('body-keywords').innerHTML=`<div class="tags">${F().search_terms.map((t,i)=>tg(t,`rmKw(${i})`)).join('')}</div><div class="add-row"><input id="nKw" placeholder="Nuova keyword..." onkeydown="if(event.key==='Enter')addKw()"/><button class="btn btn-primary" onclick="addKw()">+</button></div>`}
function addKw(){const v=$('nKw').value.trim();if(!v||F().search_terms.includes(v))return;F().search_terms.push(v);rKeywords();uc('keywords',F().search_terms.length);markDirty()}
function rmKw(i){F().search_terms.splice(i,1);rKeywords();uc('keywords',F().search_terms.length);markDirty()}

function rBroad(){$('body-broad').innerHTML=`<div class="tags">${F().broad_keywords.map((t,i)=>tg(t,`rmBr(${i})`)).join('')}</div><div class="add-row"><input id="nBr" placeholder="Keyword broad..." onkeydown="if(event.key==='Enter')addBr()"/><button class="btn btn-primary" onclick="addBr()">+</button></div>`}
function addBr(){const v=$('nBr').value.trim();if(!v||F().broad_keywords.includes(v))return;F().broad_keywords.push(v);rBroad();uc('broad',F().broad_keywords.length);markDirty()}
function rmBr(i){F().broad_keywords.splice(i,1);rBroad();uc('broad',F().broad_keywords.length);markDirty()}

function rAgencies(){$('body-agencies').innerHTML=`<div class="tags">${F().agencies.map((t,i)=>tg(t,`rmAg(${i})`)).join('')}</div><div class="add-row"><input id="nAg" placeholder="Agenzia..." onkeydown="if(event.key==='Enter')addAg()"/><button class="btn btn-primary" onclick="addAg()">+</button></div>`}
function addAg(){const v=$('nAg').value.trim();if(!v||F().agencies.includes(v))return;F().agencies.push(v);rAgencies();uc('agencies',F().agencies.length);markDirty()}
function rmAg(i){F().agencies.splice(i,1);rAgencies();uc('agencies',F().agencies.length);markDirty()}

const RC=['Talent Acquisition','HR Business Partner','HR Generalist','HR Manager','Recruiting','HR Specialist','Head Hunting','Employer Branding','Gestione Filiale APL','Agenzie Lavoro','Altro'];
function rRelevant(){$('body-relevant').innerHTML=`<div style="overflow-x:auto"><table class="pattern-table"><thead><tr><th>Pattern</th><th>Cat</th><th></th></tr></thead><tbody>${F().relevant_patterns.map((p,i)=>`<tr><td class="mono">${esc(p.pattern)}</td><td><span class="cat">${esc(p.category)}</span></td><td><button class="btn btn-danger" style="padding:3px 7px;font-size:.72rem" onclick="rmRel(${i})">‚úó</button></td></tr>`).join('')}</tbody></table></div><div class="add-row" style="margin-top:10px"><input id="nRp" placeholder="Pattern regex..." style="flex:2"/><select id="nRc">${RC.map(c=>`<option>${c}</option>`).join('')}</select><button class="btn btn-primary" onclick="addRel()">+</button></div>`}
function addRel(){const p=$('nRp').value.trim(),c=$('nRc').value;if(!p)return;try{new RegExp(p,'i')}catch(e){return toast('Regex non valida',true)}F().relevant_patterns.push({pattern:p,category:c,note:''});rRelevant();uc('relevant',F().relevant_patterns.length);markDirty()}
function rmRel(i){F().relevant_patterns.splice(i,1);rRelevant();uc('relevant',F().relevant_patterns.length);markDirty()}

const BC=['Tech / IT','Operations','Food / Retail','Finance / Legal','Sales / Marketing','Medical / Admin','Bandi pubblici','Misc'];
function rBlacklist(){const g={};F().blacklist.forEach((b,i)=>{const c=b.category||'Misc';if(!g[c])g[c]=[];g[c].push({...b,_i:i})});
  $('body-blacklist').innerHTML=Object.entries(g).map(([c,items])=>`<div style="margin-bottom:14px"><div style="font-size:.75rem;color:var(--text-dim);margin-bottom:4px;text-transform:uppercase">${esc(c)}</div><div class="tags">${items.map(b=>`<span class="tag" style="border-color:rgba(231,76,60,.3)"><span class="mono" style="font-size:.72rem;color:var(--danger)">${esc(b.pattern)}</span><button class="remove" onclick="rmBl(${b._i})">‚úó</button></span>`).join('')}</div></div>`).join('')+`<div class="add-row" style="margin-top:10px"><input id="nBl" placeholder="Pattern..." style="flex:2"/><select id="nBc">${BC.map(c=>`<option>${c}</option>`).join('')}</select><button class="btn btn-danger" style="border:none;background:var(--danger);color:#fff" onclick="addBl()">+ Blocca</button></div>`}
function addBl(){const p=$('nBl').value.trim(),c=$('nBc').value;if(!p)return;try{new RegExp(p,'i')}catch(e){return toast('Regex non valida',true)}F().blacklist.push({pattern:p,category:c});rBlacklist();uc('blacklist',F().blacklist.length);markDirty()}
function rmBl(i){F().blacklist.splice(i,1);rBlacklist();uc('blacklist',F().blacklist.length);markDirty()}

// Run
function renderRunSection(pid){
  $('runSection').innerHTML=`<div class="run-panel"><h2>üöÄ Scan: ${esc(profilesData.profiles[pid].name)}</h2>
    <div class="run-controls"><button class="btn btn-run" id="runBtn" onclick="triggerRun('${pid}')">‚ñ∂ Lancia Scan</button><span id="runStatusBadge"></span><span id="runTime" style="font-size:.78rem;color:var(--text-dim)"></span></div>
    <div id="runSummary"></div><div id="runResults"></div></div>`;
  loadLastRun(pid)
}
async function triggerRun(pid){
  const btn=$('runBtn');btn.disabled=true;btn.textContent='‚è≥ Avvio...';
  try{const wfs=await ghApi('actions/workflows');const wf=wfs.workflows.find(w=>w.path.includes(WF));if(!wf)throw new Error('WF non trovato');
    await fetch(`https://api.github.com/repos/${REPO}/actions/workflows/${wf.id}/dispatches`,{method:'POST',headers:{Authorization:`token ${token}`,Accept:'application/vnd.github.v3+json','Content-Type':'application/json'},body:JSON.stringify({ref:'main',inputs:{profile:pid}})});
    toast('‚úì Scan avviato!');setRunStatus('queued','In coda...');setTimeout(()=>pollRun(wf.id,pid),5000)
  }catch(e){toast('Errore: '+e.message,true);btn.disabled=false;btn.textContent='‚ñ∂ Lancia Scan'}
}
async function pollRun(wfId,pid){
  if(pollTimer)clearTimeout(pollTimer);
  try{const runs=await ghApi(`actions/workflows/${wfId}/runs?per_page=1`);if(!runs.workflow_runs.length)return;const r=runs.workflow_runs[0];
    if(r.status==='completed'){$('runBtn').disabled=false;$('runBtn').textContent='‚ñ∂ Lancia Scan';
      if(r.conclusion==='success'){setRunStatus('success','Completato');const el=Math.round((new Date(r.updated_at)-new Date(r.created_at))/1000);$('runTime').textContent=`${el}s ‚Ä¢ ${new Date(r.updated_at).toLocaleString('it-IT')}`;loadResults(pid)}
      else setRunStatus('failed','Fallito: '+r.conclusion)
    }else{setRunStatus('running',r.status==='in_progress'?'In esecuzione...':'In coda...');pollTimer=setTimeout(()=>pollRun(wfId,pid),5000)}
  }catch(e){pollTimer=setTimeout(()=>pollRun(wfId,pid),10000)}
}
async function loadLastRun(pid){
  try{const runs=await ghApi('actions/runs?per_page=5');
    const r=runs.workflow_runs.find(w=>w.status==='completed'&&w.conclusion==='success')||runs.workflow_runs[0];if(!r)return;
    if(r.status==='completed'&&r.conclusion==='success'){setRunStatus('success','Completato');const el=Math.round((new Date(r.updated_at)-new Date(r.created_at))/1000);$('runTime').textContent=`${el}s ‚Ä¢ ${new Date(r.updated_at).toLocaleString('it-IT')}`;loadResults(pid)}
    else if(r.status!=='completed'){setRunStatus('running','In corso...');$('runBtn').disabled=true;$('runBtn').textContent='‚è≥...';const wfs=await ghApi('actions/workflows');const wf=wfs.workflows.find(w=>w.path.includes(WF));if(wf)pollRun(wf.id,pid)}
  }catch(e){}
}
async function loadResults(pid){
  try{
    // Try profile-specific output dir first, then root output
    let sumPath=`output/${pid}/summary.json`,jobsDir=`output/${pid}`;
    let summary;
    try{const d=await ghGet(sumPath);summary=ghDecode(d)}catch(e){const d=await ghGet('output/summary.json');summary=ghDecode(d);jobsDir='output'}
    $('runSummary').innerHTML=`<div class="run-summary"><div class="run-stat"><div class="num">${summary.total_raw||0}</div><div class="label">Grezzo</div></div><div class="run-stat"><div class="num" style="color:var(--danger)">${summary.filtered_irrelevant||0}</div><div class="label">Scartati</div></div><div class="run-stat"><div class="num" style="color:var(--success)">${summary.new_jobs||0}</div><div class="label">Nuove</div></div><div class="run-stat"><div class="num" style="color:var(--text-dim)">${summary.duplicates_removed||0}</div><div class="label">Duplicati</div></div></div>`;
    let jobs=[];
    try{const ls=await ghApi(`contents/${jobsDir}`);const jf=ls.filter(f=>f.name.startsWith('ta_jobs_')&&f.name.endsWith('.json')).sort((a,b)=>b.name.localeCompare(a.name));
      if(jf.length){jobs=ghDecode(await ghGet(`${jobsDir}/${jf[0].name}`))}}catch(e){}
    if(jobs.length){console.log('[TA]',Object.keys(jobs[0]),jobs[0]);rResults(jobs)}
    else $('runResults').innerHTML='<p style="color:var(--text-dim);padding:10px">Nessun risultato</p>'
  }catch(e){console.warn('loadResults:',e)}
}
function rResults(jobs){
  $('runResults').innerHTML=`<h3 style="font-size:.88rem;margin-bottom:10px;color:var(--text-dim)">üìã Posizioni (${jobs.length})</h3><div class="results-wrap"><table class="results-table"><thead><tr><th>Titolo</th><th>Azienda</th><th>Canale</th><th>Luogo</th><th>Data</th><th>üîó</th></tr></thead><tbody>${jobs.map(jobRow).join('')}</tbody></table></div>`
}
function jobRow(j){
  const t=j.title||'',co=j.company||'',si=(j.site||'').toLowerCase(),lo=j.location||j.city||'';
  let url='';for(const k of['job_url','job_url_direct','url','link'])if(j[k]&&typeof j[k]==='string'&&j[k].startsWith('http')){url=j[k];break}
  let ds='';const raw=j.date_posted;if(raw!=null&&raw!==''&&raw!=='None'&&raw!=='NaT'){const n=Number(raw);if(!isNaN(n)&&n>1e9)ds=new Date(n>1e12?n:n*1000).toLocaleDateString('it-IT');else if(typeof raw==='string'&&raw.length>=10)ds=raw.slice(0,10).split('-').reverse().join('/')}
  const ch=si.includes('linkedin')?'linkedin':si.includes('indeed')?'indeed':si.includes('glassdoor')?'glassdoor':si.includes('google')?'google':'';
  return `<tr><td style="font-weight:500">${esc(t)}</td><td>${esc(co)}</td><td><span class="channel-badge ${ch}">${esc(si)}</span></td><td style="font-size:.78rem">${esc(lo)}</td><td style="font-size:.78rem;white-space:nowrap">${ds}</td><td style="text-align:center">${url?`<a href="${url}" target="_blank" rel="noopener" class="link-btn" title="Apri">‚Üó</a>`:'‚Äî'}</td></tr>`
}
function setRunStatus(s,t){$('runStatusBadge').innerHTML=`<span class="run-status ${s}"><span class="dot"></span> ${t}</span>`}

// Admin
function renderAdmin(){
  if(!usersData)return;
  $('adminSection').innerHTML=`<div class="admin-panel"><h2>üë§ Utenti</h2>
    ${usersData.users.map((u,i)=>`<div class="user-row"><span style="font-weight:500">${esc(u.username)} <span style="font-size:.72rem;color:var(--text-dim)">(${u.role})</span></span>${u.username!==currentUser.username?`<button class="btn btn-danger" style="padding:3px 8px;font-size:.72rem" onclick="rmUser(${i})">Rimuovi</button>`:'<span style="font-size:.72rem;color:var(--text-dim)">tu</span>'}</div>`).join('')}
    <div style="display:flex;gap:6px;margin-top:12px;flex-wrap:wrap"><input id="nU" placeholder="Username" style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:7px 10px;color:var(--text);font-family:inherit;font-size:.83rem"/><input id="nUp" type="password" placeholder="Password" style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:7px 10px;color:var(--text);font-family:inherit;font-size:.83rem"/><button class="btn btn-primary" onclick="addUser()">+ Utente</button></div>
  </div>`
}
async function addUser(){
  const u=$('nU').value.trim().toLowerCase(),p=$('nUp').value;if(!u||!p)return toast('Compila',true);if(p.length<6)return toast('Min 6 caratteri',true);
  if(usersData.users.find(x=>x.username===u))return toast('Esiste gi√†',true);
  usersData.users.push({username:u,password_hash:await hashPw(p),role:'user',created:new Date().toISOString()});
  try{const r=await ghPut(USERS_PATH,JSON.stringify(usersData,null,2),usersSha,`üë§ +${u}`);usersSha=r.content.sha;renderAdmin();toast('‚úì Utente aggiunto');$('nU').value='';$('nUp').value=''}catch(e){toast('Errore: '+e.message,true)}
}
async function rmUser(i){const u=usersData.users[i];if(!confirm(`Rimuovere ${u.username}?`))return;usersData.users.splice(i,1);try{const r=await ghPut(USERS_PATH,JSON.stringify(usersData,null,2),usersSha,`üë§ -${u.username}`);usersSha=r.content.sha;renderAdmin();toast('Rimosso')}catch(e){toast('Errore: '+e.message,true)}}

// Helpers
function $(id){return document.getElementById(id)}
function tg(t,oc){return `<span class="tag">${esc(t)}<button class="remove" onclick="${oc}">‚úó</button></span>`}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function uc(id,n){const el=document.querySelector(`#sec-${id} .count`);if(el)el.textContent=n}
function toast(m,e){const t=$('toast');t.textContent=m;t.className='toast show'+(e?' error':'');setTimeout(()=>t.className='toast',3000)}
</script>
</body>
</html>